{% load static %}
{% load socialaccount %}
<!DOCTYPE html>
<html lang="ko" dir="ltr">
  <head>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0" />
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/login_style.css' %}" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet" />
    <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey={{ tmap_api_key }}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <header>
      <!-- 메시지 출력 -->
      {% if messages %}
        <div class="messages">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message|safe }}</div>
          {% endfor %}
        </div>
      {% endif %}
    </header>
    <div class="main">
      <h1>검색 결과</h1>
      <p>출발지: {{ departure }}</p>
      <p>도착지: {{ destination }}</p>
      <p>유저 타입: {{ user_type }}</p>
      <div id="map_div"></div>
    </div>
    <script src="{% static 'js/main.js' %}"></script>
    <script>
      var map
      var departureLatLng = null
      var destinationLatLng = null
      var polyline
      
      window.onload = function () {
        // 지도 초기화
        map = new Tmapv2.Map('map_div', {
          center: new Tmapv2.LatLng(37.566535, 126.97796919999996), // 서울 중심 좌표
          width: '100%',
          height: '400px',
          zoom: 15
        })
      
        // 쿼리 파라미터 추출
        const urlParams = new URLSearchParams(window.location.search)
        const departureAddress = urlParams.get('departure')
        const destinationAddress = urlParams.get('destination')
      
        if (departureAddress) {
          geocodeAddress(departureAddress, 'departure')
        }
      
        if (destinationAddress) {
          geocodeAddress(destinationAddress, 'destination')
        }
      }
      
      function geocodeAddress(address, target) {
        var apiKey = '{{ tmap_api_key }}'
        var apiUrl = `https://apis.openapi.sk.com/tmap/geo/fullAddrGeo?version=1&format=json&coordType=WGS84GEO&fullAddr=${encodeURIComponent(address)}&appKey=${apiKey}`
        $.ajax({
          method: 'GET',
          url: apiUrl,
          success: function (response) {
            if (response.coordinateInfo && response.coordinateInfo.coordinate.length > 0) {
              var result = response.coordinateInfo.coordinate[0]
              var lat = result.lat || result.newLat
              var lon = result.lon || result.newLon
      
              if (lat && lon) {
                if (target === 'departure') {
                  departureLatLng = new Tmapv2.LatLng(lat, lon)
                  addMarker(lat, lon, 'departure')
                } else if (target === 'destination') {
                  destinationLatLng = new Tmapv2.LatLng(lat, lon)
                  addMarker(lat, lon, 'destination')
                }
      
                // 출발지와 도착지가 모두 정의된 경우 대중교통 경로 검색
                if (departureLatLng && destinationLatLng) {
                  searchPublicTransportRoute(departureLatLng, destinationLatLng)
                }
              } else {
                alert(`${address}에 대한 좌표 정보를 찾을 수 없습니다.`)
              }
            } else {
              alert(`${address}에 대한 좌표 정보를 찾을 수 없습니다.`)
            }
          },
          error: function () {
            alert('지오코딩에 실패했습니다.')
          }
        })
      }
      
      function addMarker(lat, lon, target) {
        var iconUrl
      
        if (target === 'departure') {
          iconUrl = "{% static 'img/departure-marker.png' %}"
        } else if (target === 'destination') {
          iconUrl = "{% static 'img/destination-marker.png' %}"
        }
      
        var marker = new Tmapv2.Marker({
          position: new Tmapv2.LatLng(lat, lon),
          map: map,
          icon: iconUrl,
          iconSize: new Tmapv2.Size(40, 40)
        })
      
        // 지도 중앙을 마커로 이동
        map.setCenter(new Tmapv2.LatLng(lat, lon))
      }
      
      function searchPublicTransportRoute(startLatLng, endLatLng) {
        var apiKey = '{{ tmap_api_key }}';
        var apiUrl = 'https://apis.openapi.sk.com/transit/routes'; // API 엔드포인트
    
        var requestData = {
            startX: startLatLng.lng().toString(),
            startY: startLatLng.lat().toString(),
            endX: endLatLng.lng().toString(),
            endY: endLatLng.lat().toString(),
            lang: 0,
            count: 5
        };
    
        $.ajax({
            url: apiUrl,
            method: 'POST',
            headers: {
                accept: 'application/json',
                'content-type': 'application/json',
                appKey: apiKey
            },
            data: JSON.stringify(requestData),
            success: function (response) {
                if (response.metaData.plan && response.metaData.plan.itineraries) {
                    // 기존 폴리라인 제거 (이미 있을 경우)
                    if (polyline) {
                        polyline.setMap(null);
                    }
    
                    // 경로 좌표를 담을 배열
                    var pathCoordinates = [];
    
                    response.metaData.plan.itineraries.forEach((itinerary) => {
                        itinerary.legs.forEach((leg) => {
                            // passShape를 이용한 경로 그리기
                            if (leg.passShape && leg.passShape.linestring) {
                                var coordsArray = leg.passShape.linestring.split(' ');
                                coordsArray.forEach((coord) => {
                                    var latLon = coord.split(',');
                                    var lat = parseFloat(latLon[1]);
                                    var lon = parseFloat(latLon[0]);
    
                                    if (!isNaN(lat) && !isNaN(lon)) {
                                        pathCoordinates.push(new Tmapv2.LatLng(lat, lon));
                                    }
                                });
                            } else {
                                // passShape가 없을 때는 기존 방식대로 step을 이용해 경로 그리기
                                for (var stepKey in leg.steps) {
                                    if (leg.steps.hasOwnProperty(stepKey)) {
                                        var step = leg.steps[stepKey];
                                        
                                        if (step.linestring) {
                                            var coordsArray = step.linestring.split(' ');
                                            coordsArray.forEach((coord) => {
                                                var latLon = coord.split(',');
                                                var lat = parseFloat(latLon[1]);
                                                var lon = parseFloat(latLon[0]);
    
                                                if (!isNaN(lat) && !isNaN(lon)) {
                                                    pathCoordinates.push(new Tmapv2.LatLng(lat, lon));
                                                }
                                            });
                                        }
                                    }
                                }
                            }
                        });
                    });
    
                    // 폴리라인 생성
                    if (pathCoordinates.length > 0) {
                        polyline = new Tmapv2.Polyline({
                            path: pathCoordinates,
                            strokeColor: '#FF0000', // 라인 색상
                            strokeWeight: 6, // 라인 두께
                            map: map
                        });
    
                        // 경로를 중심으로 지도 확대
                        var bounds = new Tmapv2.LatLngBounds();
                        pathCoordinates.forEach((coord) => bounds.extend(coord));
                        map.fitBounds(bounds);
                    }
                } else {
                    console.error('경로 탐색 실패:', response);
                }
            },
            error: function (xhr, status, error) {
                console.error('API 호출 실패:', status, error);
                alert('대중교통 경로 검색에 실패했습니다.');
            }
        });
    }
    </script>
  </body>
</html>
