{% load static %}
{% load socialaccount %}
<!DOCTYPE html>
<html lang="ko" dir="ltr">
  <head>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0" />
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/login_style.css' %}" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet" />
    <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey={{ tmap_api_key }}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <header>
      <!-- 메시지 출력 -->
      {% if messages %}
        <div class="messages">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message|safe }}</div>
          {% endfor %}
        </div>
      {% endif %}
    </header>
    <div class="main">
      <h1>검색 결과</h1>
      <p>출발지: {{ departure }}</p>
      <p>도착지: {{ destination }}</p>
      <p>유저 타입: {{ user_type }}</p>
      <div id="map_div"></div>
    </div>
    <script src="{% static 'js/main.js' %}"></script>
    <script>
      var map
      
      window.onload = function () {
        // 지도 초기화
        map = new Tmapv2.Map('map_div', {
          center: new Tmapv2.LatLng(37.566535, 126.97796919999996), // 서울 중심 좌표
          width: '100%',
          height: '400px',
          zoom: 15
        })
      
        // 쿼리 파라미터 추출
        const urlParams = new URLSearchParams(window.location.search)
        const departureAddress = urlParams.get('departure')
        const destinationAddress = urlParams.get('destination')
      
        if (departureAddress) {
          geocodeAddress(departureAddress, 'departure')
        }
      
        if (destinationAddress) {
          geocodeAddress(destinationAddress, 'destination')
        }
      }
      
      function geocodeAddress(address, target) {
        var apiKey = '{{ tmap_api_key }}'
        var apiUrl = `https://apis.openapi.sk.com/tmap/geo/fullAddrGeo?version=1&format=json&coordType=WGS84GEO&fullAddr=${encodeURIComponent(address)}&appKey=${apiKey}`
      
        $.ajax({
          method: 'GET',
          url: apiUrl,
          success: function (response) {
            if (response.coordinateInfo && response.coordinateInfo.coordinate.length > 0) {
              var result = response.coordinateInfo.coordinate[0]
              var lat = result.lat || result.newLat
              var lon = result.lon || result.newLon
      
              if (lat && lon) {
                // 지도에 마커 추가
                addMarker(lat, lon, target)
              } else {
                alert(`${address}에 대한 좌표 정보를 찾을 수 없습니다.`)
              }
            } else {
              alert(`${address}에 대한 좌표 정보를 찾을 수 없습니다.`)
            }
          },
          error: function () {
            alert('지오코딩에 실패했습니다.')
          }
        })
      }
      
      function addMarker(lat, lon, target) {
        var iconUrl
      
        if (target === 'departure') {
          iconUrl = "{% static 'img/departure-marker.png' %}"
        } else if (target === 'destination') {
          iconUrl = "{% static 'img/destination-marker.png' %}"
        }
      
        var marker = new Tmapv2.Marker({
          position: new Tmapv2.LatLng(lat, lon),
          map: map,
          icon: iconUrl,
          iconSize: new Tmapv2.Size(40, 40)
        })
      
        // 지도 중앙을 마커로 이동
        map.setCenter(new Tmapv2.LatLng(lat, lon))
      }
    </script>
  </body>
</html>
