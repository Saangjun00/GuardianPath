{% load static %}
{% load socialaccount %}
<!DOCTYPE html>
<html lang="ko" dir="ltr">
  <head>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0" />
    <meta charset="utf-8" />
    <link rel="stylesheet" type="text/css" href="{% static 'css/login_style.css' %}" />
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700;800&display=swap" rel="stylesheet" />
    <script src="https://apis.openapi.sk.com/tmap/jsv2?version=1&appKey={{ tmap_api_key }}"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  </head>
  <body>
    <header>
      <!-- 메시지 출력 -->
      {% if messages %}
        <div class="messages">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }}">{{ message|safe }}</div>
          {% endfor %}
        </div>
      {% endif %}
    </header>
    <div class="main">
      <div id="map_div"></div>
      <div id="route_info" class="route-info">
        <h3>경로 상세 정보</h3>
        <div id="route_detail"></div>
        <div id="route_list" class="route-list">
          <h3>경로 리스트</h3>
          <ul id="itinerary_list"></ul>
    </div>
    <script src="{% static 'js/main.js' %}"></script>
    <script>
      var map
      var departureLatLng = null
      var destinationLatLng = null
      var polyline
      var currentPolyline = null
      
      window.onload = function () {
        // 지도 초기화
        map = new Tmapv2.Map('map_div', {
          center: new Tmapv2.LatLng(37.566535, 126.97796919999996), // 서울 중심 좌표
          width: '100%',
          height: '400px',
          zoom: 15
        })
      
        // 쿼리 파라미터 추출
        const urlParams = new URLSearchParams(window.location.search)
        const departureAddress = urlParams.get('departure')
        const destinationAddress = urlParams.get('destination')
      
        if (departureAddress) {
          geocodeAddress(departureAddress, 'departure')
        }
      
        if (destinationAddress) {
          geocodeAddress(destinationAddress, 'destination')
        }
      }
      
      function geocodeAddress(address, target) {
        var apiKey = '{{ tmap_api_key }}'
        var apiUrl = `https://apis.openapi.sk.com/tmap/geo/fullAddrGeo?version=1&format=json&coordType=WGS84GEO&fullAddr=${encodeURIComponent(address)}&appKey=${apiKey}`
        $.ajax({
          method: 'GET',
          url: apiUrl,
          success: function (response) {
            if (response.coordinateInfo && response.coordinateInfo.coordinate.length > 0) {
              var result = response.coordinateInfo.coordinate[0]
              var lat = result.lat || result.newLat
              var lon = result.lon || result.newLon
      
              if (lat && lon) {
                if (target === 'departure') {
                  departureLatLng = new Tmapv2.LatLng(lat, lon)
                  addMarker(lat, lon, 'departure')
                } else if (target === 'destination') {
                  destinationLatLng = new Tmapv2.LatLng(lat, lon)
                  addMarker(lat, lon, 'destination')
                }
      
                // 출발지와 도착지가 모두 정의된 경우 대중교통 경로 검색
                if (departureLatLng && destinationLatLng) {
                  searchPublicTransportRoute(departureLatLng, destinationLatLng)
                }
              } else {
                alert(`${address}에 대한 좌표 정보를 찾을 수 없습니다.`)
              }
            } else {
              alert(`${address}에 대한 좌표 정보를 찾을 수 없습니다.`)
            }
          },
          error: function () {
            alert('지오코딩에 실패했습니다.')
          }
        })
      }
      
      function addMarker(lat, lon, target) {
        var iconUrl
      
        if (target === 'departure') {
          iconUrl = "{% static 'img/departure-marker.png' %}"
        } else if (target === 'destination') {
          iconUrl = "{% static 'img/destination-marker.png' %}"
        }
      
        var marker = new Tmapv2.Marker({
          position: new Tmapv2.LatLng(lat, lon),
          map: map,
          icon: iconUrl,
          iconSize: new Tmapv2.Size(40, 40)
        })
      
        // 지도 중앙을 마커로 이동
        map.setCenter(new Tmapv2.LatLng(lat, lon))
      }
      
      function searchPublicTransportRoute(startLatLng, endLatLng) {
        var apiKey = '{{ tmap_api_key }}';
        var apiUrl = 'https://apis.openapi.sk.com/transit/routes';
      
        var requestData = {
          startX: startLatLng.lng().toString(),
          startY: startLatLng.lat().toString(),
          endX: endLatLng.lng().toString(),
          endY: endLatLng.lat().toString(),
          lang: 0,
          count: 5,
        };
      
        $.ajax({
          url: apiUrl,
          method: 'POST',
          headers: {
            accept: 'application/json',
            'content-type': 'application/json',
            appKey: apiKey,
          },
          data: JSON.stringify(requestData),
          success: function (response) {
            if (response.metaData.plan && response.metaData.plan.itineraries) {
              var itineraryList = document.getElementById('itinerary_list');
              itineraryList.innerHTML = '';
      
              response.metaData.plan.itineraries.forEach((itinerary, index) => {
                var listItem = document.createElement('li');
                listItem.innerText = `경로 ${index + 1}`;
                listItem.onclick = function () {
                  displayRouteInfo(itinerary, index);
                };
                itineraryList.appendChild(listItem);
              });
            } else {
              console.error('경로 탐색 실패:', response);
            }
          },
          error: function (xhr, status, error) {
            console.error('API 호출 실패:', status, error);
            alert('대중교통 경로 검색에 실패했습니다.');
          },
        });
      }
      
      function displayRouteInfo(itinerary, index) {
        var routeDetailDiv = document.getElementById('route_detail');
        routeDetailDiv.innerHTML = `
          <p><strong>경로 타입:</strong> ${itinerary.mode || 'N/A'}</p>
          <p><strong>총 거리:</strong> ${itinerary.distance ? itinerary.distance.toFixed(2) + ' km' : 'N/A'}</p>
          <h4>세부 구간</h4>
          <ul>
            ${itinerary.legs
              .map(
                (leg) =>
                  `<li><strong>구간 타입:</strong> ${leg.mode || 'N/A'}, <strong>노선명:</strong> ${
                    leg.route || 'N/A'
                  }</li>`
              )
              .join('')}
          </ul>
        `;
      
        // 이전 경로 삭제
        if (currentPolyline) {
          currentPolyline.setMap(null);
        }
      
        // 새로운 경로 폴리라인 그리기
        var pathCoordinates = [];
        itinerary.legs.forEach((leg) => {
          if (leg.passShape && leg.passShape.linestring) {
            var coordsArray = leg.passShape.linestring.split(' ');
            coordsArray.forEach((coord) => {
              var latLon = coord.split(',');
              var lat = parseFloat(latLon[1]);
              var lon = parseFloat(latLon[0]);
      
              if (!isNaN(lat) && !isNaN(lon)) {
                pathCoordinates.push(new Tmapv2.LatLng(lat, lon));
              }
            });
          }
        });
      
        if (pathCoordinates.length > 0) {
          currentPolyline = new Tmapv2.Polyline({
            path: pathCoordinates,
            strokeColor: '#0000FF',
            strokeWeight: 6,
            map: map,
          });
      
          var bounds = new Tmapv2.LatLngBounds();
          pathCoordinates.forEach((coord) => bounds.extend(coord));
          map.fitBounds(bounds);
        }
      }
    </script>
  </body>
</html>
